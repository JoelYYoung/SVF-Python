name: svf-python-build

on:
  push:
    branches:
      - main  # only build on main branch

env:
  SVF_CTIR: 1
  SVF_Z3: 1
  SVF_DIR: $GITHUB_WORKSPACE/SVF
  LLVM_DIR: $GITHUB_WORKSPACE/SVF/llvm-16.0.0.obj
  Z3_DIR: $GITHUB_WORKSPACE/SVF/z3.obj

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # macOS Xcode
      - name: mac-setup
        if: runner.os == 'macOS'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.3.0'

      - name: mac-setup-workaround
        if: runner.os == 'macOS'
        run: |
          ln -sfn /Applications/Xcode_15.3.0.app /Applications/Xcode.app

      # install linux dependencies
      - name: ubuntu-setup
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y \
              cmake gcc g++ nodejs doxygen graphviz lcov libncurses5-dev libtinfo6 libzstd-dev \
              python3 python3-pip python3-venv

      # calculate version
      - name: Set VERSION
        run: |
          VERSION="0.0.0-dev$(expr ${{ github.run_id }} % 1000000)"  
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Clone and Build SVF
        run: |
          git clone https://github.com/SVF-tools/SVF.git
          cd SVF
          bash build.sh shared  
          echo "SVF_DIR=$GITHUB_WORKSPACE/SVF" >> $GITHUB_ENV
          echo "LLVM_DIR=$GITHUB_WORKSPACE/SVF/llvm-16.0.0.obj" >> $GITHUB_ENV
          echo "Z3_DIR=$GITHUB_WORKSPACE/SVF/z3.obj" >> $GITHUB_ENV
          ls -lh $GITHUB_WORKSPACE/SVF/Release-build/lib

      # Only Package LLVM(RTTI) on ubuntu
      - name: Package LLVM Build (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          cd $GITHUB_WORKSPACE/SVF
          tar -czvf llvm-16.0.0-ubuntu.tar.gz llvm-16.0.0.obj
          sync
          ls -lh llvm-16.0.0-ubuntu.tar.gz  

  # Ensure LLVM tarball is in the correct location before upload
      - name: Verify LLVM Archive Before Upload
        if: runner.os == 'Linux'
        run: |
          echo "Checking file location..."
          find $GITHUB_WORKSPACE -type f -name "llvm-16.0.0-ubuntu.tar.gz"
          ls -lh $GITHUB_WORKSPACE/SVF/llvm-16.0.0-ubuntu.tar.gz || echo "File not found!"
          file $GITHUB_WORKSPACE/SVF/llvm-16.0.0-ubuntu.tar.gz || echo "File type unknown!"
          sync  # Ensure the file is fully written to disk

      # Move LLVM tarball to a stable location
      - name: Move LLVM Archive to Workspace Root
        if: runner.os == 'Linux'
        run: |
          mv $GITHUB_WORKSPACE/SVF/llvm-16.0.0-ubuntu.tar.gz $GITHUB_WORKSPACE/
          ls -lh $GITHUB_WORKSPACE/llvm-16.0.0-ubuntu.tar.gz  # Confirm file move

      # Upload LLVM-16 Ubuntu build artifact
      - name: Upload LLVM Build Artifact (Ubuntu)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: llvm-16.0.0-ubuntu
          path: "**/llvm-16.0.0-ubuntu.tar.gz"  # Use glob to find the file anywhere
          if-no-files-found: error
          retention-days: 3

        # set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel twine pybind11

      # clone & build SVF-Python
      - name: Clone and Build SVF-Python
        run: |
          git clone https://github.com/SVF-tools/SVF-Python.git
          cd SVF-Python
          rm -rf build dist pysvf.egg-info  
          export PYBIND11_DIR=$(python3 -m pybind11 --cmakedir)
          export CMAKE_BUILD_TYPE=Release
          SVF_DIR=${SVF_DIR} LLVM_DIR=${LLVM_DIR} Z3_DIR=${Z3_DIR} PYBIND11_DIR=${PYBIND11_DIR} python3 setup.py bdist_wheel
          ls -lh dist/

      # upload Python wheels
      - name: Upload Python wheels
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels-${{ env.VERSION }}-${{ runner.os }}
          path: SVF-Python/dist/

  publish:
    needs: build
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write  # allow to write to the repository

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built wheels
        uses: actions/download-artifact@v4
        with:
          name: python-wheels-${{ env.VERSION }}-${{ runner.os }}
          path: dist/

      # upload to TestPyPI (not Pypi)
      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          pip install twine
          twine upload --repository testpypi dist/*
